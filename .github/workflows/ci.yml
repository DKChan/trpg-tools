name: CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]

jobs:
  # 后端测试
  backend-test:
    name: Backend Tests (Go)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          go mod download
          go get github.com/stretchr/testify

      - name: Run tests
        working-directory: ./backend
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        working-directory: ./backend
        run: go tool cover -func=coverage.out

      - name: Check coverage threshold
        working-directory: ./backend
        run: |
          total_coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${total_coverage}%"
          if (( $(echo "$total_coverage < 70" | bc -l) )); then
            echo "Coverage ${total_coverage}% is below threshold 70%"
            exit 1
          else
            echo "Coverage ${total_coverage}% meets threshold 70%"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.out
          flags: backend
          name: backend-coverage

  # 前端测试
  frontend-test:
    name: Frontend Tests (React)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests
        working-directory: ./frontend
        run: npm run test:run

      - name: Generate coverage report
        working-directory: ./frontend
        run: npm run test:coverage

      - name: Check coverage threshold
        working-directory: ./frontend
        run: |
          # 检查覆盖率是否达到 70%
          # 注意：实际命令可能需要根据覆盖率报告格式调整
          echo "Checking frontend coverage threshold (70%)"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage

  # Linting
  lint:
    name: Code Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ./backend

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

  # Build
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build backend
        working-directory: ./backend
        run: go build -o bin/trpg-sync

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
